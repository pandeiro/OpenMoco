# OpenMoko v0.4 Improvements Plan

**Created:** 2026-02-27
**Status:** Draft
**Priority Order:** Tasks listed in recommended execution order

---

## Overview

This plan addresses codebase improvements identified during a comprehensive review, focusing on:
- PWA completeness
- Production reliability
- Documentation accuracy
- Code quality
- OpenCode integration enhancements

---

## Task List

### Task 1: PWA Icons
**Priority:** P0 (Critical)
**Effort:** Small (~15 min)
**Dependencies:** None

**Problem:** `init/public/icons/` directory is empty but `manifest.json` references `icon-192.png` and `icon-512.png`. PWA installation fails without these.

**Solution:** Use ImageMagick to generate icons from `logo.png`.

**Files to change:**
- `init/public/icons/icon-192.png` (create)
- `init/public/icons/icon-512.png` (create)
- `init/public/icons/favicon.ico` (create, optional)
- `init/index.html` (update favicon link if needed)

**Implementation:**
```bash
convert logo.png -resize 192x192 init/public/icons/icon-192.png
convert logo.png -resize 512x512 init/public/icons/icon-512.png
convert logo.png -resize 32x32 init/public/icons/favicon.ico
```

**Verification:**
- PWA install prompt appears on mobile
- Icons display correctly on home screen
- Favicon shows in browser tab

---

### Task 2: Create PRD v0.4
**Priority:** P0 (Critical)
**Effort:** Medium (~1 hour)
**Dependencies:** None

**Problem:** Current PRD (v0.3) describes Groq as primary reformulation provider, but implementation uses Gemini. Documentation drift causes confusion.

**Solution:** Create `doc/prd/openmoko-prd-v0.4.md` that reflects current implementation and documents v0.4 scope.

**Changes from v0.3:**
- Gemini 2.5 Flash is primary reformulation provider (not Groq)
- Ollama Cloud remains as fallback
- Document multi-arch Docker builds (optional via workflow_dispatch)
- Update architecture diagrams if needed
- Add v0.4 features:
  - OpenCode event capture plugin
  - Docker health checks
  - Graceful shutdown

**Files to change:**
- `doc/prd/openmoko-prd-v0.4.md` (create)
- `doc/status/v0.3-completion.md` (mark as complete)
- `doc/status/v0.4-progress.md` (create for tracking)

**Verification:**
- PRD accurately reflects current implementation
- No conflicting information between PRD and code

---

### Task 3: Docker Health Checks
**Priority:** P1 (High)
**Effort:** Small (~30 min)
**Dependencies:** None

**Problem:** No health checks defined in `docker-compose.yml`. Docker cannot detect unhealthy services; restart policies are ineffective.

**Solution:** Add health checks to all 4 services.

**Files to change:**
- `docker-compose.yml`

**Implementation:**
```yaml
services:
  agent:
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  events:
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  init:
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3

  gateway:
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/init/"]
      interval: 30s
      timeout: 10s
      retries: 3
```

**Note:** May need to add `/health` endpoint to agent if OpenCode doesn't provide one. Investigate first.

**Verification:**
- `docker ps` shows health status for all containers
- Unhealthy containers are detected and logged

---

### Task 4: README Reorganization & Deployment Docs
**Priority:** P1 (High)
**Effort:** Medium (~1 hour)
**Dependencies:** None

**Problem:** 
- README references `doc/deployment.md` which doesn't exist
- README could benefit from reorganization
- Missing troubleshooting guidance

**Solution:** Reorganize README and add deployment section directly.

**Proposed README Structure:**
```
1. Header + Screenshot
2. Quick Setup (streamlined)
3. Architecture (brief)
4. Configuration
   - Environment Variables
   - GitHub Webhook Setup
5. Deployment
   - Local Development
   - Production VPS (HTTPS, domain)
   - Multi-arch Builds
6. Usage
   - Managing Repositories
   - Starting a Task
   - Resuming Failures
7. Troubleshooting
   - Common issues and solutions
8. Persistence
9. License
```

**Files to change:**
- `README.md` (major reorganization)

**Content to add:**
- Production deployment with Caddy/Nginx reverse proxy
- SSL certificate setup (Let's Encrypt)
- Multi-arch build instructions (already added)
- Troubleshooting section:
  - "Clone failed" → SSH key permissions
  - "Push not working" → VAPID key setup
  - "Transcription failed" → API key issues
  - "Disk full on server" → cleanup steps

**Verification:**
- No broken links
- New user can follow Quick Setup successfully
- Production deployment is documented

---

### Task 5: Input Validation & Error Logging in Events
**Priority:** P2 (Medium)
**Effort:** Medium (~2 hours)
**Dependencies:** None

**Problem:** 
- API routes accept any input without validation
- Silent failures in data layer make debugging difficult

**Solution:** Add validation middleware and improve error logging.

**Files to change:**
- `events/package.json` (add express-validator)
- `events/server.js` (add validation error handler)
- `events/lib/data.js` (add error logging)
- `events/routes/*.js` (add validation where needed)

**Implementation:**

1. Add dependency:
```bash
cd events && npm install express-validator
```

2. Add logging to data layer (`events/lib/data.js`):
```javascript
export async function readJSON(relativePath) {
  const fullPath = join(DATA_DIR, relativePath);
  try {
    const content = await fs.readFile(fullPath, 'utf-8');
    return JSON.parse(content);
  } catch (err) {
    console.error(`[data] Failed to read ${relativePath}:`, err.message);
    return null;
  }
}
```

3. Add validation to critical routes (example for `repos.js`):
```javascript
import { param, validationResult } from 'express-validator';

router.post('/:owner/:name/clone',
  param('owner').isAlphanumeric().trim(),
  param('name').isAlphanumeric().replace(/-/g, '-').trim(),
  async (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
      return res.status(400).json({ errors: errors.array() });
    }
    // ... existing logic
  }
);
```

**Routes needing validation:**
- `repos.js` - owner/name params, filesystem operations
- `session.js` - prompt text, project path
- `subscribe.js` - push subscription data

**Verification:**
- Invalid inputs return 400 with clear error messages
- Error logs appear in console for debugging
- No regressions in existing functionality

---

### Task 6: Use Repo Default Branch from GitHub Metadata
**Priority:** P2 (Medium)
**Effort:** Small (~30 min)
**Dependencies:** None

**Problem:** `events/routes/repos.js:155` hardcodes `origin/main` when resetting repos. Fails for repos with `master` as default branch.

**Solution:** Use `default_branch` from GitHub API response.

**Files to change:**
- `events/routes/repos.js`

**Current code:**
```javascript
execSync(`git fetch origin main && git reset --hard origin/main`, { cwd: repoPath });
```

**Fixed code:**
```javascript
const defaultBranch = repo.default_branch || 'main';
execSync(`git fetch origin ${defaultBranch} && git reset --hard origin/${defaultBranch}`, { cwd: repoPath });
```

**Note:** The `repo` object comes from GitHub API and includes `default_branch` field. Verify it's stored in `repos.json`.

**Verification:**
- Test with a repo that uses `master` as default
- Clone/reset works correctly

---

### Task 7: Graceful Shutdown for Events Server
**Priority:** P2 (Medium)
**Effort:** Small (~20 min)
**Dependencies:** None

**Problem:** No SIGTERM/SIGINT handlers. In-flight requests may be terminated abruptly during `docker compose pull/up` deployments.

**Solution:** Add graceful shutdown handlers.

**Files to change:**
- `events/server.js`

**Implementation:**
```javascript
const PORT = process.env.PORT || 3001;

// ... existing code ...

async function start() {
  await ensureDataDir();
  const server = app.listen(PORT, '0.0.0.0', () => {
    console.log(`openmoko-events listening on port ${PORT}`);
  });

  // Graceful shutdown
  const shutdown = (signal) => {
    console.log(`\n[${signal}] Starting graceful shutdown...`);
    server.close(() => {
      console.log('[shutdown] HTTP server closed');
      process.exit(0);
    });

    // Force close after 10s
    setTimeout(() => {
      console.error('[shutdown] Forced shutdown after timeout');
      process.exit(1);
    }, 10000);
  };

  process.on('SIGTERM', () => shutdown('SIGTERM'));
  process.on('SIGINT', () => shutdown('SIGINT'));
}

start().catch((err) => {
  console.error('Failed to start events service:', err);
  process.exit(1);
});
```

**Verification:**
- `docker compose restart events` logs graceful shutdown
- No abrupt connection terminations

---

### Task 8: Consolidate Agent Documentation
**Priority:** P3 (Low)
**Effort:** Small (~30 min)
**Dependencies:** None

**Problem:** `AGENTS.md` and `GEMINI.md` have overlapping content. Two files to maintain.

**Solution:** 
1. Consolidate into single `AGENTS.md`
2. Symlink `GEMINI.md` → `AGENTS.md`

**Files to change:**
- `AGENTS.md` (consolidate, keep best content from both)
- `GEMINI.md` (delete, recreate as symlink)

**Content to keep from GEMINI.md:**
- Nothing unique; AGENTS.md is more comprehensive

**Additional improvements to AGENTS.md:**
- Add section on OpenCode event capture plugin
- Reference this plan document
- Clarify provider configuration (Gemini primary)

**Implementation:**
```bash
rm GEMINI.md
ln -s AGENTS.md GEMINI.md
```

**Verification:**
- `cat GEMINI.md` shows same content as `AGENTS.md`
- Both files tracked correctly by git

---

### Task 9: OpenCode Event Capture Plugin
**Priority:** P2 (Medium)
**Effort:** Medium (~2-3 hours)
**Dependencies:** None

**Problem:** No visibility into what the agent is doing during sessions. Users can't see token usage, tool calls, or activity when away.

**Solution:** Create an OpenCode plugin that logs events to console (Docker captures stdout, Loki collects).

**Reference:** `example-opencode-plugin/opencode/plugin/token-tracker.ts`

**Files to create:**
- `opencode-plugin/package.json`
- `opencode-plugin/moko-logger.ts`

**Plugin Hooks to Implement:**
1. `event` - Raw event stream (token counts, message updates)
2. `chat.message` - User prompts
3. `tool.execute.before` - Tool call starts
4. `tool.execute.after` - Tool call completes (with output)

**Implementation Approach:**

1. Create plugin file:
```typescript
// opencode-plugin/moko-logger.ts
import type { Plugin } from "@opencode-ai/plugin";

export const MokoLoggerPlugin: Plugin = async ({ directory }) => {
  return {
    event: async ({ event }) => {
      if (event.type === "message.updated") {
        const msg = event.properties.info;
        if (msg.role === "assistant" && msg.tokens) {
          console.log(`[opencode] tokens: input=${msg.tokens.input} output=${msg.tokens.output} cost=$${msg.cost?.toFixed(4) || 0}`);
        }
      }
    },
    
    "tool.execute.after": async (input, output) => {
      const success = !String(output.output).includes("Error");
      console.log(`[opencode] tool: ${input.tool} ${success ? '✓' : '✗'}`);
    },
  };
};
```

2. Update `Dockerfile` to install plugin:
```dockerfile
# Copy and install OpenCode plugin
COPY opencode-plugin /tmp/opencode-plugin
RUN mkdir -p /root/.config/opencode/plugin && \
    cp /tmp/opencode-plugin/moko-logger.ts /root/.config/opencode/plugin/
```

3. Configure in `entrypoint.sh` or via opencode.json

**Future Enhancement (not in scope):**
- Send events to events API for dashboard
- Real-time activity feed in init PWA

**Verification:**
- `docker logs agent` shows structured event logs
- Token usage logged after each assistant message
- Tool calls logged with success/failure status

---

### Task 10: Skills/Tools Spike
**Priority:** P3 (Low)
**Effort:** Research only (~1-2 hours)
**Dependencies:** None

**Goal:** Identify useful OpenCode skills, tools, and MCP servers to include in the agent build by default.

**Research Areas:**

1. **Official OpenCode Plugins:**
   - Search opencode.ai/docs for official plugin registry
   - Identify commonly recommended plugins

2. **Community Tools:**
   - GitHub search: `topic:opencode-plugin`, `topic:mcp-server`
   - npm search for `@opencode-ai/*` packages
   - Awesome lists if they exist

3. **MCP Servers (Model Context Protocol):**
   - Filesystem access
   - Database connectors
   - API integrations

**Evaluation Criteria:**
- Actively maintained
- Well-documented
- Broad applicability (not project-specific)
- Security considerations

**Output:**
- Create `doc/research/skills-tools-spike.md` with findings
- Categorized list with recommendations
- Implementation notes for each

**Potential Candidates to Investigate:**
- Context7 / similar for enhanced context
- Database MCP servers (PostgreSQL, SQLite)
- Git-enhanced tools
- Testing/quality tools

---

### Task 11: OpenCode Go/Zen API Key Integration Spike
**Priority:** P3 (Low)
**Effort:** Research only (~1 hour)
**Dependencies:** None

**Goal:** Determine how to pre-configure OpenCode Go and OpenCode Zen providers via environment variables, so users can add API keys to `.env` and have them automatically work.

**Research Questions:**

1. **Config File Structure:**
   - How does `~/.config/opencode/opencode.json` store provider configs?
   - What fields are required for a custom provider?

2. **Environment Variable Patterns:**
   - Do these providers expect specific env var names?
   - Can we inject via `entrypoint.sh` similar to Ollama/Google?

3. **OpenCode Go:**
   - Provider ID and configuration format
   - Base URL and model names

4. **OpenCode Zen:**
   - Provider ID and configuration format
   - Base URL and model names

**Output:**
- Create `doc/research/opencode-providers-spike.md`
- Document exact config format for each provider
- Update `entrypoint.sh` with conditional provider setup
- Update `.env.example` with new optional keys

**Potential Implementation:**
```bash
# In entrypoint.sh
if [ -n "$OPENCODE_GO_API_KEY" ]; then
  # Add provider config to opencode.json
fi

if [ -n "$OPENCODE_ZEN_API_KEY" ]; then
  # Add provider config to opencode.json
fi
```

---

## Execution Order

Recommended execution order based on dependencies and priority:

| Phase | Tasks | Total Effort |
|-------|-------|--------------|
| 1. Critical Fixes | 1, 2 | ~1.25 hours |
| 2. Reliability | 3, 7 | ~1 hour |
| 3. Documentation | 4, 8 | ~1.5 hours |
| 4. Code Quality | 5, 6 | ~2.5 hours |
| 5. Enhancements | 9 | ~2-3 hours |
| 6. Research | 10, 11 | ~2-3 hours |

**Total Estimated Effort:** 10-12 hours

---

## Progress Tracking

| Task | Status | Assignee | Completed |
|------|--------|----------|-----------|
| 1. PWA Icons | Not Started | - | - |
| 2. PRD v0.4 | Not Started | - | - |
| 3. Docker Health Checks | Not Started | - | - |
| 4. README Reorg | Not Started | - | - |
| 5. Validation & Logging | Not Started | - | - |
| 6. Default Branch | Not Started | - | - |
| 7. Graceful Shutdown | Not Started | - | - |
| 8. Consolidate AGENTS.md | Not Started | - | - |
| 9. Event Capture Plugin | Not Started | - | - |
| 10. Skills/Tools Spike | Not Started | - | - |
| 11. Provider Integration Spike | Not Started | - | - |

---

## Notes

- All tasks can be worked independently except where noted
- Spike tasks (10, 11) are research-only and don't require code changes
- Task 9 (Event Capture) can be expanded later to integrate with events API
- Consider adding CI tests after Task 5 to prevent regressions
